# アーキテクチャレビュー

このリポジトリ（claude-agent）のアーキテクチャを包括的にレビューし、構造化されたMarkdownレポートを出力します。

**重要: このコマンドは読み取り専用です。コードの変更は行いません。**

## レビュー手順

以下の6つのレビュー項目を順番に実行してください。

---

### 1. プロジェクト概要の把握

以下のファイルを読んでプロジェクトの基本情報を把握：

```bash
# 読むべきファイル
- package.json（依存関係、スクリプト）
- CLAUDE.md（プロジェクト指示）
- tsconfig.json（TypeScript設定）
```

確認ポイント：
- 依存関係のバージョンは適切か
- 不要な依存関係はないか
- スクリプト定義は適切か

---

### 2. ディレクトリ構造の分析

Globツールで以下を実行：

```
# ソースファイル一覧
src/**/*.ts

# コマンド一覧
.claude/commands/*.md

# スキル一覧
skills/**/*.md
```

確認ポイント：
- CLAUDE.mdに記載のディレクトリ構成と実際の構造が一致しているか
- 各ディレクトリの責務が明確か
- 不要なファイルや孤立したファイルはないか

---

### 3. 依存関係とモジュール構造のレビュー

#### 3.1 import文の抽出

Grepツールで各ディレクトリのimport文を抽出：

```
# パターン
^import .* from ['"]\.

# 対象
src/**/*.ts（*.test.tsを除く）
```

#### 3.2 レイヤー構造の確認

期待されるレイヤー構造：
```
types/     → 型定義のみ、他への依存なし
core/      → types/のみに依存可
prompts/   → types/, core/に依存可
commands/  → types/, core/, prompts/に依存可
hooks/     → すべてに依存可
index.ts   → commandsのエントリーポイント
```

確認ポイント：
- 循環参照がないか（A→B→A）
- 下位レイヤーが上位レイヤーに依存していないか
  - 例: core/がcommands/をimportしていたらNG

---

### 4. コード品質と一貫性のレビュー

#### 4.1 命名規則

確認ポイント：
- ファイル名: kebab-case（例: `issue-apply.ts`）
- 関数名: camelCase（例: `createIssue`）
- クラス名: PascalCase（例: `GitHubClient`）
- 定数: UPPER_SNAKE_CASE または camelCase
- 型/インターフェース: PascalCase（例: `IssueOptions`）

#### 4.2 エクスポートパターン

確認ポイント：
- named export vs default exportの一貫性
- 再エクスポート（barrel exports）の使用状況
- types/index.tsで型が適切に集約されているか

#### 4.3 エラーハンドリング

Grepで確認：
```
# try-catchの使用
try \{

# throw文の使用
throw new

# エラー型の定義
class.*Error
```

#### 4.4 重複コード

類似した処理がないか目視確認：
- ログ出力パターン
- GitHub API呼び出しパターン
- ファイル操作パターン

---

### 5. テストカバレッジの確認

#### 5.1 テスト対応状況の確認

各ソースファイルに対応する`.test.ts`ファイルが存在するか確認：

```
# ソースファイル（テストファイルと型定義を除く）
src/**/*.ts
除外: *.test.ts, *.d.ts, types/

# 各ファイルに対して
src/foo.ts → src/foo.test.ts が存在するか
```

#### 5.2 テスト品質

確認ポイント：
- 主要な関数にテストがあるか
- エッジケースがテストされているか
- モックの使用は適切か

---

### 6. セキュリティと設定のレビュー

#### 6.1 環境変数の使用

Grepで確認：
```
process\.env
```

確認ポイント：
- 環境変数はCLAUDE.mdに記載されているか
- デフォルト値の扱いは適切か
- 機密情報（APIキー等）がハードコードされていないか

#### 6.2 .gitignoreの確認

確認ポイント：
- `node_modules/`が除外されているか
- `.env`ファイルが除外されているか
- ビルド成果物（`dist/`）が除外されているか
- 機密情報を含む可能性のあるファイルが除外されているか

---

## 出力フォーマット

レビュー完了後、以下のフォーマットでレポートを出力してください：

```markdown
# アーキテクチャレビューレポート

## 実行日時
[YYYY-MM-DD]

## 1. プロジェクト概要
- プロジェクト名: claude-agent
- バージョン: [package.jsonから]
- 主要依存関係:
  - @anthropic-ai/claude-code: [バージョン]
  - commander: [バージョン]
  - simple-git: [バージョン]
  - @octokit/rest: [バージョン]

## 2. ディレクトリ構造
[実際の構造をツリー形式で表示]

### CLAUDE.mdとの整合性
- [OK/不整合あり]: [詳細]

## 3. モジュール依存関係

### 3.1 依存関係マップ
[ファイルごとの依存先をリスト形式で表示]

### 3.2 循環参照
- 検出数: [N件]
- 詳細: [あれば列挙]

### 3.3 レイヤー違反
- 検出数: [N件]
- 詳細: [あれば列挙]

## 4. コード品質

### 4.1 命名規則
- 評価: [OK/要改善]
- 問題箇所: [あれば列挙]

### 4.2 エクスポートパターン
- 評価: [OK/要改善]
- 問題箇所: [あれば列挙]

### 4.3 エラーハンドリング
- 評価: [OK/要改善]
- 問題箇所: [あれば列挙]

### 4.4 重複コード
- 検出数: [N件]
- 詳細: [あれば列挙]

## 5. テストカバレッジ

### 5.1 テスト対応状況
| ソースファイル | テストファイル | 状態 |
|--------------|--------------|------|
| src/core/agent.ts | src/core/agent.test.ts | [OK/なし] |
| ... | ... | ... |

### 5.2 テスト未作成ファイル
- [ファイル一覧]

## 6. セキュリティ

### 6.1 環境変数
| 変数名 | 使用ファイル | CLAUDE.md記載 |
|-------|------------|--------------|
| GH_TOKEN | src/core/github.ts | [OK/なし] |
| ... | ... | ... |

### 6.2 .gitignore
- 評価: [OK/要改善]
- 問題箇所: [あれば列挙]

## 7. 改善提案

### 優先度: 高
- [重大な問題や即座に対応すべき項目]

### 優先度: 中
- [改善が望ましい項目]

### 優先度: 低
- [あれば良い改善項目]

## 8. 総評
[全体的な評価とコメント]
- アーキテクチャの健全性: [良好/要改善/問題あり]
- 特に良い点: [列挙]
- 改善が必要な点: [列挙]
```

---

## 注意事項

- このコマンドはclaude-agentリポジトリ専用です
- レビューは読み取り専用で、コードの変更は行いません
- 効率的にGlob/Grepを使用し、必要なファイルのみ読み込んでください
- 問題を発見した場合は具体的なファイルパスと行番号を記載してください
